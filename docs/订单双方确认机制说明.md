# 订单双方确认机制说明

## 背景

原有逻辑存在快递丢失风险：接单者点击"完成订单"后，钱立即转账给接单者，但发布者无法验证快递是否真的送达。这可能导致：
1. 接单者恶意点击"完成"但未送达
2. 接单者误操作点击"完成"
3. 发布者完全被动，无法控制资金流向

## 解决方案

实现**双方确认机制**，保护发布者权益：

### 新流程

1. **接单者标记送达** → 订单状态变为 `DELIVERED`（待确认）
   - 接口：`POST /order/{orderId}/deliver`
   - 权限：只有接单者本人可操作
   - 操作：更新订单状态为待确认，记录送达时间
   - **不转账**

2. **发布者确认收货** → 订单状态变为 `COMPLETED`（已完成）
   - 接口：`POST /order/{orderId}/confirm`
   - 权限：只有发布者本人可操作
   - 操作：验证订单状态，计算实际报酬，**转账给接单者**

3. **自动确认机制** → 防止恶意拖延
   - 定时任务：每小时执行一次
   - 规则：超过24小时未确认的订单自动确认并转账
   - 类：`OrderAutoConfirmTask`

### 订单状态变更

| 状态码 | 状态名称 | 说明 |
|-------|---------|------|
| 1 | 待接单 | PENDING |
| 2 | 已接单 | ACCEPTED |
| 3 | 待确认 | DELIVERED（新增） |
| 4 | 已完成 | COMPLETED |
| 5 | 已取消 | CANCELLED |

## 技术实现

### 1. 数据库变更

**新增字段：**
- `deliver_time` DATETIME：送达时间（接单者标记送达的时间）
- 索引：`idx_deliver_time`

**状态码调整：**
- 已完成：3 → 4
- 已取消：4 → 5
- 新增待确认：3

**迁移脚本：** `db/migration_add_deliver_time.sql`

### 2. 代码变更

#### 枚举类
- `OrderStatus.java`：新增 `DELIVERED(3, "待确认")`

#### 实体类
- `Order.java`：新增 `deliverTime` 字段

#### Controller
- `OrderController.java`：
  - 新增 `POST /order/{orderId}/deliver`：接单者标记送达
  - 新增 `POST /order/{orderId}/confirm`：发布者确认收货
  - 保留 `POST /order/{orderId}/complete`（已废弃，兼容旧版本）

#### Service
- `OrderService.java`：
  - 新增 `deliverOrder()`：只更新状态，不转账
  - 新增 `confirmOrder()`：验证发布者身份后转账
  - 保留 `completeOrder()`（已废弃）

#### Mapper
- `OrderMapper.java`：
  - 新增 `deliverOrder()`：更新状态为待确认
  - 新增 `findDeliveredOrdersBeforeTime()`：查询超时待确认订单
- `OrderMapper.xml`：新增对应SQL

#### 定时任务
- `OrderAutoConfirmTask.java`：
  - 每小时执行一次（cron: `0 0 * * * ?`）
  - 自动确认超过24小时未确认的订单

#### 主类
- `FetchbeeBackendApplication.java`：添加 `@EnableScheduling` 启用定时任务

## 部署步骤

### 1. 执行数据库迁移

```sql
-- 在数据库中执行迁移脚本
source db/migration_add_deliver_time.sql;
```

### 2. 重启后端服务

```bash
# 编译
mvn clean package

# 运行
java -jar target/fetchbee-backend-0.0.1-SNAPSHOT.jar
```

### 3. 验证功能

1. 接单者标记送达：`POST /order/{orderId}/deliver`
2. 发布者确认收货：`POST /order/{orderId}/confirm`
3. 查看定时任务日志，确认自动确认功能正常

## 接口示例

### 接单者标记送达

```bash
POST /order/123/deliver
Authorization: Bearer {token}
```

**响应：**
```json
{
  "code": 200,
  "message": "已标记送达，等待发布者确认",
  "data": null
}
```

### 发布者确认收货

```bash
POST /order/123/confirm
Authorization: Bearer {token}
```

**响应：**
```json
{
  "code": 200,
  "message": "订单已完成",
  "data": null
}
```

## 注意事项

1. **兼容性**：保留了旧的 `/complete` 接口，但已标记为 `@Deprecated`
2. **数据迁移**：需要执行迁移脚本更新现有订单的状态码
3. **定时任务**：确保服务器时间准确，避免自动确认时间不准
4. **前端适配**：前端需要适配新的订单状态和接口

## 优势

✅ **保护发布者权益**：发布者确认后才转账，防止快递丢失  
✅ **保护接单者权益**：自动确认机制防止恶意拖延  
✅ **清晰的状态流转**：待确认状态让双方都清楚订单进度  
✅ **向后兼容**：保留旧接口，平滑过渡

## 后续优化建议

1. 增加消息通知：接单者送达后通知发布者确认
2. 增加申诉机制：发布者可申诉未收到快递
3. 调整自动确认时间：可配置化，不同场景不同时间
4. 增加评价系统：完成后双方互评，提高信用度
